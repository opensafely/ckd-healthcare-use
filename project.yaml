version: "3.0"

expectations:
  population_size: 50000

actions:

  2017:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2017
    outputs:
      highly_sensitive:
        cohort: output/input_2017.csv

  2017_ckd:
    run: stata-mp:latest analysis/ckd.do 2017
    needs: [2017]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2017_ckd.csv
      moderately_sensitive:
        log: logs/2017_ckd.log
  
  2017_ckd_complete:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2017_ckd_complete
    needs: [2017, 2017_ckd]
    outputs:
      highly_sensitive:
        cohort: output/input_2017_ckd_complete.csv

  2017_clean_ckd_complete:
    run: stata-mp:latest analysis/ckd_complete.do 2017
    needs: [2017, 2017_ckd, 2017_ckd_complete, costs_2017]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2017_ckd_complete.dta
      moderately_sensitive:
        log: logs/2017_ckd_complete.log

  2018:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2018
    outputs:
      highly_sensitive:
        cohort: output/input_2018.csv

  2018_ckd:
    run: stata-mp:latest analysis/ckd.do 2018
    needs: [2018]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2018_ckd.csv
      moderately_sensitive:
        log: logs/2018_ckd.log
  
  2018_ckd_complete:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2018_ckd_complete
    needs: [2018, 2018_ckd]
    outputs:
      highly_sensitive:
        cohort: output/input_2018_ckd_complete.csv

  2018_clean_ckd_complete:
    run: stata-mp:latest analysis/ckd_complete.do 2018
    needs: [2018, 2018_ckd, 2018_ckd_complete, costs_2018]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2018_ckd_complete.dta
      moderately_sensitive:
        log: logs/2018_ckd_complete.log

  2019:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019
    outputs:
      highly_sensitive:
        cohort: output/input_2019.csv

  2019_ckd:
    run: stata-mp:latest analysis/ckd.do 2019
    needs: [2019]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2019_ckd.csv
      moderately_sensitive:
        log: logs/2019_ckd.log
  
  2019_ckd_complete:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2019_ckd_complete
    needs: [2019, 2019_ckd]
    outputs:
      highly_sensitive:
        cohort: output/input_2019_ckd_complete.csv

  2019_clean_ckd_complete:
    run: stata-mp:latest analysis/ckd_complete.do 2019
    needs: [2019, 2019_ckd, 2019_ckd_complete, costs_2019]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2019_ckd_complete.dta
      moderately_sensitive:
        log: logs/2019_ckd_complete.log

  2020:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2020
    outputs:
      highly_sensitive:
        cohort: output/input_2020.csv

  2020_ckd:
    run: stata-mp:latest analysis/ckd.do 2020
    needs: [2020]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2020_ckd.csv
      moderately_sensitive:
        log: logs/2020_ckd.log
  
  2020_ckd_complete:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2020_ckd_complete
    needs: [2020, 2020_ckd]
    outputs:
      highly_sensitive:
        cohort: output/input_2020_ckd_complete.csv

  2020_clean_ckd_complete:
    run: stata-mp:latest analysis/ckd_complete.do 2020
    needs: [2020, 2020_ckd, 2020_ckd_complete, costs_2020]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2020_ckd_complete.dta
      moderately_sensitive:
        log: logs/2020_ckd_complete.log

  2021:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2021
    outputs:
      highly_sensitive:
        cohort: output/input_2021.csv

  2021_ckd:
    run: stata-mp:latest analysis/ckd.do 2021
    needs: [2021]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2021_ckd.csv
      moderately_sensitive:
        log: logs/2021_ckd.log
  
  2021_ckd_complete:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2021_ckd_complete
    needs: [2021, 2021_ckd]
    outputs:
      highly_sensitive:
        cohort: output/input_2021_ckd_complete.csv

  2021_clean_ckd_complete:
    run: stata-mp:latest analysis/ckd_complete.do 2021
    needs: [2021, 2021_ckd, 2021_ckd_complete, costs_2021]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2021_ckd_complete.dta
      moderately_sensitive:
        log: logs/2021_ckd_complete.log

  2022:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2022
    outputs:
      highly_sensitive:
        cohort: output/input_2022.csv

  2022_ckd:
    run: stata-mp:latest analysis/ckd.do 2022
    needs: [2022]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2022_ckd.csv
      moderately_sensitive:
        log: logs/2022_ckd.log
  
  2022_ckd_complete:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2022_ckd_complete
    needs: [2022, 2022_ckd]
    outputs:
      highly_sensitive:
        cohort: output/input_2022_ckd_complete.csv

  2022_clean_ckd_complete:
    run: stata-mp:latest analysis/ckd_complete.do 2022
    needs: [2022, 2022_ckd, 2022_ckd_complete, costs_2022]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2022_ckd_complete.dta
      moderately_sensitive:
        log: logs/2022_ckd_complete.log

  2023:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2023
    outputs:
      highly_sensitive:
        cohort: output/input_2023.csv

  2023_ckd:
    run: stata-mp:latest analysis/ckd.do 2023
    needs: [2023]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2023_ckd.csv
      moderately_sensitive:
        log: logs/2023_ckd.log
  
  2023_ckd_complete:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2023_ckd_complete
    needs: [2023, 2023_ckd]
    outputs:
      highly_sensitive:
        cohort: output/input_2023_ckd_complete.csv

  2023_clean_ckd_complete:
    run: stata-mp:latest analysis/ckd_complete.do 2023
    needs: [2023, 2023_ckd, 2023_ckd_complete]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2023_ckd_complete.dta
      moderately_sensitive:
        log: logs/2023_ckd_complete.log

  ckd_progression:
    run: stata-mp:latest analysis/ckd_progression.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/ckd_progression.log
        output: output/ckd_progression.csv

  healthcare_use_overall:
    run: stata-mp:latest analysis/healthcare_use_overall.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/healthcare_use_overall.log
        output: output/healthcare_use_overall.csv

  healthcare_use_albuminuria:
    run: stata-mp:latest analysis/healthcare_use_albuminuria.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/healthcare_use_albuminuria.log
        output: output/healthcare_use_albuminuria.csv

  healthcare_use_ckd3:
    run: stata-mp:latest analysis/healthcare_use_ckd3.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/healthcare_use_ckd3.log
        output: output/healthcare_use_ckd3.csv

  healthcare_use_ckd4:
    run: stata-mp:latest analysis/healthcare_use_ckd4.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/healthcare_use_ckd4.log
        output: output/healthcare_use_ckd4.csv

  healthcare_use_dialysis:
    run: stata-mp:latest analysis/healthcare_use_dialysis.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/healthcare_use_dialysis.log
        output: output/healthcare_use_dialysis.csv

  healthcare_use_transplant:
    run: stata-mp:latest analysis/healthcare_use_transplant.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/healthcare_use_transplant.log
        output: output/healthcare_use_transplant.csv

  absolute_healthcare_use_overall:
    run: stata-mp:latest analysis/absolute_healthcare_use_overall.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/absolute_healthcare_use_overall.log
        output: output/absolute_healthcare_use_overall.csv

  absolute_healthcare_use_albuminuria:
    run: stata-mp:latest analysis/absolute_healthcare_use_albuminuria.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/absolute_healthcare_use_albuminuria.log
        output: output/absolute_healthcare_use_albuminuria.csv

  absolute_healthcare_use_ckd3:
    run: stata-mp:latest analysis/absolute_healthcare_use_ckd3.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/absolute_healthcare_use_ckd3.log
        output: output/absolute_healthcare_use_ckd3.csv

  absolute_healthcare_use_ckd4:
    run: stata-mp:latest analysis/absolute_healthcare_use_ckd4.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/absolute_healthcare_use_ckd4.log
        output: output/absolute_healthcare_use_ckd4.csv

  absolute_healthcare_use_dialysis:
    run: stata-mp:latest analysis/absolute_healthcare_use_dialysis.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/absolute_healthcare_use_dialysis.log
        output: output/absolute_healthcare_use_dialysis.csv

  absolute_healthcare_use_transplant:
    run: stata-mp:latest analysis/absolute_healthcare_use_transplant.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/absolute_healthcare_use_transplant.log
        output: output/absolute_healthcare_use_transplant.csv

  relative_healthcare_use_overall:
    run: stata-mp:latest analysis/relative_healthcare_use_overall.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_healthcare_use_overall.log
        output: output/relative_healthcare_use_overall.csv

  relative_healthcare_use_albuminuria:
    run: stata-mp:latest analysis/relative_healthcare_use_albuminuria.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_healthcare_use_albuminuria.log
        output: output/relative_healthcare_use_albuminuria.csv

  relative_healthcare_use_ckd3:
    run: stata-mp:latest analysis/relative_healthcare_use_ckd3.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_healthcare_use_ckd3.log
        output: output/relative_healthcare_use_ckd3.csv

  relative_healthcare_use_ckd4:
    run: stata-mp:latest analysis/relative_healthcare_use_ckd4.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_healthcare_use_ckd4.log
        output: output/relative_healthcare_use_ckd4.csv

  relative_healthcare_use_dialysis:
    run: stata-mp:latest analysis/relative_healthcare_use_dialysis.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_healthcare_use_dialysis.log
        output: output/relative_healthcare_use_dialysis.csv

  relative_healthcare_use_transplant:
    run: stata-mp:latest analysis/relative_healthcare_use_transplant.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_healthcare_use_transplant.log
        output: output/relative_healthcare_use_transplant.csv

  costs_2017:
    run: >
      databuilder:v0 
        generate-dataset analysis/costs_2017.py --output output/costs_2017.csv
    outputs:
      highly_sensitive:
        costs_2017: output/costs_2017.csv 

  costs_2018:
    run: >
      databuilder:v0 
        generate-dataset analysis/costs_2018.py --output output/costs_2018.csv
    outputs:
      highly_sensitive:
        costs_2018: output/costs_2018.csv

  costs_2019:
    run: >
      databuilder:v0 
        generate-dataset analysis/costs_2019.py --output output/costs_2019.csv
    outputs:
      highly_sensitive:
        costs_2019: output/costs_2019.csv 

  costs_2020:
    run: >
      databuilder:v0 
        generate-dataset analysis/costs_2020.py --output output/costs_2020.csv
    outputs:
      highly_sensitive:
        costs_2020: output/costs_2020.csv

  costs_2021:
    run: >
      databuilder:v0 
        generate-dataset analysis/costs_2021.py --output output/costs_2021.csv
    outputs:
      highly_sensitive:
        costs_2021: output/costs_2021.csv

  costs_2022:
    run: >
      databuilder:v0 
        generate-dataset analysis/costs_2022.py --output output/costs_2022.csv
    outputs:
      highly_sensitive:
        costs_2022: output/costs_2022.csv

  costs_overall:
    run: stata-mp:latest analysis/costs_overall.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/costs_overall.log
        output: output/costs_overall.csv

  costs_albuminuria:
    run: stata-mp:latest analysis/costs_albuminuria.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/costs_albuminuria.log
        output: output/costs_albuminuria.csv

  costs_ckd3:
    run: stata-mp:latest analysis/costs_ckd3.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/costs_ckd3.log
        output: output/costs_ckd3.csv

  costs_ckd4:
    run: stata-mp:latest analysis/costs_ckd4.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/costs_ckd4.log
        output: output/costs_ckd4.csv

  costs_dialysis:
    run: stata-mp:latest analysis/costs_dialysis.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/costs_dialysis.log
        output: output/costs_dialysis.csv

  costs_transplant:
    run: stata-mp:latest analysis/costs_transplant.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/costs_transplant.log
        output: output/costs_transplant.csv

  relative_costs_overall:
    run: stata-mp:latest analysis/relative_costs_overall.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_costs_overall.log
        output: output/relative_costs_overall.csv

  relative_costs_albuminuria:
    run: stata-mp:latest analysis/relative_costs_albuminuria.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_costs_albuminuria.log
        output: output/relative_costs_albuminuria.csv

  relative_costs_ckd3:
    run: stata-mp:latest analysis/relative_costs_ckd3.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_costs_ckd3.log
        output: output/relative_costs_ckd3.csv

  relative_costs_ckd4:
    run: stata-mp:latest analysis/relative_costs_ckd4.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_costs_ckd4.log
        output: output/relative_costs_ckd4.csv

  relative_costs_dialysis:
    run: stata-mp:latest analysis/relative_costs_dialysis.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_costs_dialysis.log
        output: output/relative_costs_dialysis.csv

  relative_costs_transplant:
    run: stata-mp:latest analysis/relative_costs_transplant.do
    needs: [2017_clean_ckd_complete, 2018_clean_ckd_complete, 2019_clean_ckd_complete, 2020_clean_ckd_complete, 2021_clean_ckd_complete, 2022_clean_ckd_complete]
    outputs:
      moderately_sensitive:
        log: logs/relative_costs_transplant.log
        output: output/relative_costs_transplant.csv