-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /workspace/logs/2022_ckd_complete.log
  log type:  text
 opened on:   7 Jun 2024, 10:22:29

. clear

. 
. *Merge `dataset'_ckd with `dataset'_ckd_complete
. capture noisily import delimited ./output/`dataset'_ckd.csv, clear
(9 vars, 21,038 obs)

. tempfile `dataset'_ckd

. save ``dataset'_ckd', replace
(note: file /tmp/St00012.000001 not found)
file /tmp/St00012.000001 saved

. capture noisily import delimited ./output/input_`dataset'_ckd_complete.csv, c
> lear
(104 vars, 50,000 obs)

. merge 1:1 patient_id using ``dataset'_ckd'

    Result                           # of obs.
    -----------------------------------------
    not matched                        66,624
        from master                    47,793  (_merge==1)
        from using                     18,831  (_merge==2)

    matched                             2,207  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(66,624 observations deleted)

. drop _merge

. tempfile `dataset'_ckd_complete

. save ``dataset'_ckd_complete', replace
(note: file /tmp/St00012.000002 not found)
file /tmp/St00012.000002 saved

. 
. /*Generate dummy data
> cd ckd-healthcare-use
> capture noisily import delimited ./output/2017_ckd.csv, clear
> tempfile 2017_ckd
> save ./output/2017_ckd, replace
> capture noisily import delimited ./output/input_2017_ckd_complete.csv, clear
> merge 1:1 patient_id using ./output/2017_ckd
> keep if _merge==3
> drop _merge
> tempfile 2017_ckd_complete
> save ./output/2017_ckd_complete, replace
> */
. 
. *CKD stage classification
. foreach var of varlist  dialysis_baseline_primary_care  ///
>                                                 dialysis_baseline_icd_10     
>            ///
>                                                 dialysis_baseline_opcs_4     
>            ///
>                                                 dialysis_baseline_date       
>            ///
>                                                 kt_baseline_primary_care     
>            ///
>                                                 kt_baseline_icd_10           
>                    ///
>                                                 kt_baseline_opcs_4           
>                    {
  2.         drop `var'
  3.         }

. tab modality_baseline, m

modality_baseline |      Freq.     Percent        Cum.
------------------+-----------------------------------
         Dialysis |        204        9.24        9.24
Kidney transplant |        208        9.42       18.67
 Modality unclear |         51        2.31       20.98
          Pre KRT |      1,744       79.02      100.00
------------------+-----------------------------------
            Total |      2,207      100.00

. *To reduce misclassification of dialysis, anyone with eGFR >15 with modality_
> baseline=="Dialysis" will be reclassified as non-dialysis (e.g. they may have
>  received acute dialysis and recovered)
. *For modality_baseline="Modality unclear" (i.e. whose dialysis and kidney tra
> nsplant baseline dates are identical), those with eGFR <15 will be assumed to
>  be on dialysis and those >15 as kidney transplant
. egen esrd_egfr = cut(baseline_egfr), at (0, 15, 5000)
(881 missing values generated)

. recode esrd_egfr 0=1 15=0
(esrd_egfr: 1326 changes made)

. tab esrd_egfr, m

  esrd_egfr |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,326       60.08       60.08
          . |        881       39.92      100.00
------------+-----------------------------------
      Total |      2,207      100.00

. gen dialysis = 0

. replace dialysis = 1 if modality_baseline=="Dialysis"
(204 real changes made)

. replace dialysis = 1 if modality_baseline=="Modality unclear" & esrd_egfr!=.
(32 real changes made)

. replace dialysis = 0 if esrd_egfr==0
(144 real changes made)

. gen kidney_transplant = 0

. replace kidney_transplant = 1 if kidney_transplant_baseline_date!=""
(330 real changes made)

. replace kidney_transplant = 0 if dialysis==1
(23 real changes made)

. gen modality_unclear = 0

. replace modality_unclear = 1 if modality_baseline=="Modality unclear"
(51 real changes made)

. replace modality_unclear = 0 if dialysis==1
(0 real changes made)

. replace modality_unclear = 0 if kidney_transplant==1
(6 real changes made)

. tab modality_baseline dialysis

                  |       dialysis
modality_baseline |         0          1 |     Total
------------------+----------------------+----------
         Dialysis |       112         92 |       204 
Kidney transplant |       208          0 |       208 
 Modality unclear |        51          0 |        51 
          Pre KRT |     1,744          0 |     1,744 
------------------+----------------------+----------
            Total |     2,115         92 |     2,207 

. tab modality_baseline kidney_transplant

                  |   kidney_transplant
modality_baseline |         0          1 |     Total
------------------+----------------------+----------
         Dialysis |       180         24 |       204 
Kidney transplant |       168         40 |       208 
 Modality unclear |        45          6 |        51 
          Pre KRT |     1,507        237 |     1,744 
------------------+----------------------+----------
            Total |     1,900        307 |     2,207 

. tab modality_baseline modality_unclear

                  |   modality_unclear
modality_baseline |         0          1 |     Total
------------------+----------------------+----------
         Dialysis |       204          0 |       204 
Kidney transplant |       208          0 |       208 
 Modality unclear |         6         45 |        51 
          Pre KRT |     1,744          0 |     1,744 
------------------+----------------------+----------
            Total |     2,162         45 |     2,207 

. tab dialysis kidney_transplant

           |   kidney_transplant
  dialysis |         0          1 |     Total
-----------+----------------------+----------
         0 |     1,808        307 |     2,115 
         1 |        92          0 |        92 
-----------+----------------------+----------
     Total |     1,900        307 |     2,207 

. egen ckd_group = cut(baseline_egfr), at(0, 30, 60, 5000)
(881 missing values generated)

. recode ckd_group 0=3 30=2 60=1
(ckd_group: 1326 changes made)

. replace ckd_group = 4 if dialysis==1
(92 real changes made)

. replace ckd_group = 5 if kidney_transplant==1
(307 real changes made)

. replace ckd_group = 6 if modality_unclear==1
(45 real changes made)

. *ckd_group==. are those with albuminuria without available eGFR measurement o
> r code for KRT
. replace ckd_group = 1 if ckd_group==.
(665 real changes made)

. label define ckd_group 1 "Albuminuria" 2 "CKD stage 3" 3 "CKD stage 4/5" 4 "D
> ialysis" 5 "Transplant" 6 "KRT unclear modality"

. label values ckd_group ckd_group

. label var ckd_group "CKD group"

. tab ckd_group, m

           CKD group |      Freq.     Percent        Cum.
---------------------+-----------------------------------
         Albuminuria |      1,353       61.30       61.30
         CKD stage 3 |        392       17.76       79.07
       CKD stage 4/5 |         18        0.82       79.88
            Dialysis |         92        4.17       84.05
          Transplant |        307       13.91       97.96
KRT unclear modality |         45        2.04      100.00
---------------------+-----------------------------------
               Total |      2,207      100.00

. drop if ckd_group==.
(0 observations deleted)

. tab ckd_group modality_baseline

                     |              modality_baseline
           CKD group |  Dialysis  Kidney ..  Modalit..    Pre KRT |     Total
---------------------+--------------------------------------------+----------
         Albuminuria |        55        132          0      1,166 |     1,353 
         CKD stage 3 |        32         35          0        325 |       392 
       CKD stage 4/5 |         1          1          0         16 |        18 
            Dialysis |        92          0          0          0 |        92 
          Transplant |        24         40          6        237 |       307 
KRT unclear modality |         0          0         45          0 |        45 
---------------------+--------------------------------------------+----------
               Total |       204        208         51      1,744 |     2,207 

. 
. *Dialysis & kidney transplant outcome classification
. foreach var of varlist  dialysis_outcome_primary_care   ///
>                                                 dialysis_outcome_icd_10      
>            ///
>                                                 dialysis_outcome_opcs_4      
>            ///
>                                                 dialysis_outcome_date        
>            ///
>                                                 kt_outcome_primary_care      
>            ///
>                                                 kt_outcome_icd_10            
>                    ///
>                                                 kt_outcome_opcs_4            
>                    ///
>                                                 kidney_transplant_outcome_dat
> e  ///
>                                                 died                         
>                            {
  2.         drop `var'
  3.         }

. tab ckd_group modality_outcome, m

                     |              modality_outcome
           CKD group |  Deceased   Dialysis  Kidney ..  Modalit.. |     Total
---------------------+--------------------------------------------+----------
         Albuminuria |       135         63         62          9 |     1,353 
         CKD stage 3 |        49         17         16          4 |       392 
       CKD stage 4/5 |         1          2          0          0 |        18 
            Dialysis |        13          3          3          3 |        92 
          Transplant |        29         20         15          1 |       307 
KRT unclear modality |         1          3          4          1 |        45 
---------------------+--------------------------------------------+----------
               Total |       228        108        100         18 |     2,207 


                     | modality_o
                     |   utcome
           CKD group | Unchanged |     Total
---------------------+-----------+----------
         Albuminuria |     1,084 |     1,353 
         CKD stage 3 |       306 |       392 
       CKD stage 4/5 |        15 |        18 
            Dialysis |        70 |        92 
          Transplant |       242 |       307 
KRT unclear modality |        36 |        45 
---------------------+-----------+----------
               Total |     1,753 |     2,207 

. 
. *eGFR outcome classification based on updated mean eGFR over previous 18 mont
> hs by the end of year
. gen sex = 1 if male == "Male"
(1,153 missing values generated)

. replace sex = 0 if male == "Female"
(1,153 real changes made)

. label define sex 0"Female" 1"Male"

. label values sex sex

. replace creatinine_outcome = . if !inrange(creatinine_outcome, 20, 3000)
(954 real changes made, 954 to missing)

. gen mgdl_creatinine_outcome = creatinine_outcome/88.4
(954 missing values generated)

. gen min_creatinine_outcome=.
(2,207 missing values generated)

. replace min_creatinine_outcome = mgdl_creatinine_outcome/0.7 if sex==0
(662 real changes made)

. replace min_creatinine_outcome = mgdl_creatinine_outcome/0.9 if sex==1
(591 real changes made)

. replace min_creatinine_outcome = min_creatinine_outcome^-0.329  if sex==0
(662 real changes made)

. replace min_creatinine_outcome = min_creatinine_outcome^-0.411  if sex==1
(591 real changes made)

. replace min_creatinine_outcome = 1 if min_creatinine_outcome<1
(775 real changes made)

. gen max_creatinine_outcome=.
(2,207 missing values generated)

. replace max_creatinine_outcome = mgdl_creatinine_outcome/0.7 if sex==0
(662 real changes made)

. replace max_creatinine_outcome = mgdl_creatinine_outcome/0.9 if sex==1
(591 real changes made)

. replace max_creatinine_outcome = max_creatinine_outcome^-1.209
(1,253 real changes made)

. replace max_creatinine_outcome = 1 if max_creatinine_outcome>1
(1,432 real changes made)

. gen egfr_outcome = min_creatinine_outcome*max_creatinine_outcome*141
(954 missing values generated)

. replace egfr_outcome = egfr_outcome*(0.993^age)
(1,253 real changes made)

. replace egfr_outcome = egfr_outcome*1.018 if sex==0
(662 real changes made)

. drop creatinine_outcome

. drop mgdl_creatinine_outcome

. drop min_creatinine_outcome

. drop max_creatinine_outcome

. egen egfr_end = cut(egfr_outcome), at(0, 30, 60, 5000)
(954 missing values generated)

. recode egfr_end 0=3 30=2 60=1
(egfr_end: 1253 changes made)

. label define egfr_end 1 "≥60" 2 "30-59" 3 "<30"

. label values egfr_end egfr_end

. label var egfr_end "Final eGFR"

. gen ckd_progression = 0

. replace ckd_progression = 1 if egfr_end==2 & ckd_group==1
(197 real changes made)

. replace ckd_progression = 2 if egfr_end==3 & ckd_group==1
(7 real changes made)

. replace ckd_progression = 2 if egfr_end==3 & ckd_group==2
(4 real changes made)

. egen esrd_egfr_end = cut(egfr_outcome), at (0, 15, 5000)
(954 missing values generated)

. recode esrd_egfr_end 0=1 15=0
(esrd_egfr_end: 1253 changes made)

. tab esrd_egfr_end, m

esrd_egfr_e |
         nd |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,253       56.77       56.77
          . |        954       43.23      100.00
------------+-----------------------------------
      Total |      2,207      100.00

. gen dialysis_outcome = 0

. replace dialysis_outcome = 1 if modality_outcome=="Dialysis"
(108 real changes made)

. replace dialysis_outcome = 1 if modality_outcome=="Modality unclear" & esrd_e
> gfr_end==1
(0 real changes made)

. gen kidney_transplant_outcome = 0

. replace kidney_transplant_outcome = 1 if modality_outcome=="Kidney transplant
> "
(100 real changes made)

. replace kidney_transplant_outcome = 1 if modality_outcome=="Modality unclear"
>  & esrd_egfr_end==0
(10 real changes made)

. replace ckd_progression = 5 if modality_outcome=="Modality unclear"
(18 real changes made)

. replace ckd_progression = 3 if dialysis_outcome==1
(108 real changes made)

. replace ckd_progression = 4 if kidney_transplant_outcome==1
(110 real changes made)

. replace ckd_progression = 6 if modality_outcome=="Deceased"
(228 real changes made)

. label define ckd_progression 0 "No progression" 1 "CKD 3" 2 "CKD 4/5 pre-KRT"
>  3 "Dialysis" 4 "Kidney transplant" 5 "KRT unclear modality" 6 "Deceased"

. label values ckd_progression ckd_progression

. label var ckd_progression "CKD progression"

. tab ckd_progression, m

     CKD progression |      Freq.     Percent        Cum.
---------------------+-----------------------------------
      No progression |      1,592       72.13       72.13
               CKD 3 |        151        6.84       78.98
     CKD 4/5 pre-KRT |         10        0.45       79.43
            Dialysis |        108        4.89       84.32
   Kidney transplant |        110        4.98       89.31
KRT unclear modality |          8        0.36       89.67
            Deceased |        228       10.33      100.00
---------------------+-----------------------------------
               Total |      2,207      100.00

. 
. *eGFR cut-offs to investigate timing of access formation
. egen access_egfr = cut(baseline_egfr), at (0, 15, 5000)
(881 missing values generated)

. recode access_egfr 0=1 15=2
(access_egfr: 1326 changes made)

. replace access_egfr=0 if ckd_group==4
(92 real changes made)

. replace access_egfr=3 if access_egfr==.
(789 real changes made)

. label define access_egfr 0 "Dialysis" 1 "eGFR 0-14" 2 "eGFR >= 15" 3 "Unknown
> "

. label values access_egfr access_egfr

. 
. *Totals for non-binary healthcare resource outcomes (including by month)
. foreach aggregate of varlist hospital_days critical_care_days emergency_days 
> op_appts neph_appts tx_appts gp_interactions icd1_days icd2_days icd3_days ic
> d4_days icd5_days icd6_days icd7_days icd8_days icd9_days icd10_days icd11_da
> ys icd12_days icd13_days icd14_days icd15_days icd16_days icd17_days icd18_da
> ys icd19_days icd20_days icd21_days icd22_days {
  2. bysort ckd_group: egen total_`aggregate' = total(`aggregate')
  3. egen overall_`aggregate' = total(`aggregate')
  4. tab ckd_group, sum(total_`aggregate')
  5. sum overall_`aggregate'
  6. }

            |   Summary of total_hospital_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         384           0       1,353
  CKD stage |          89           0         392
  CKD stage |           0           0          18
   Dialysis |          14           0          92
  Transplan |          54           0         307
  KRT uncle |          13           0          45
------------+------------------------------------
      Total |   259.57907   157.64492       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_ho~s |      2,207         554           0        554        554

            | Summary of total_critical_care_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         293           0       1,353
  CKD stage |          87           0         392
  CKD stage |           6           0          18
   Dialysis |          46           0          92
  Transplan |         103           0         307
  KRT uncle |           9           0          45
------------+------------------------------------
      Total |   211.55369   103.87433       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_cr~s |      2,207         544           0        544        544

            |   Summary of total_emergency_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         338           0       1,353
  CKD stage |          92           0         392
  CKD stage |           6           0          18
   Dialysis |          15           0          92
  Transplan |          81           0         307
  KRT uncle |          11           0          45
------------+------------------------------------
      Total |   235.71726   130.03995       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_em~s |      2,207         543           0        543        543

            |      Summary of total_op_appts
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         383           0       1,353
  CKD stage |          77           0         392
  CKD stage |           0           0          18
   Dialysis |          24           0          92
  Transplan |          89           0         307
  KRT uncle |          13           0          45
------------+------------------------------------
      Total |   262.12007   153.01522       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_op~s |      2,207         586           0        586        586

            |     Summary of total_neph_appts
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         372           0       1,353
  CKD stage |          87           0         392
  CKD stage |           9           0          18
   Dialysis |          23           0          92
  Transplan |          56           0         307
  KRT uncle |          29           0          45
------------+------------------------------------
      Total |   252.92025   150.65963       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_ne~s |      2,207         576           0        576        576

            |      Summary of total_tx_appts
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         363           0       1,353
  CKD stage |          99           0         392
  CKD stage |           3           0          18
   Dialysis |          14           0          92
  Transplan |          94           0         307
  KRT uncle |           7           0          45
------------+------------------------------------
      Total |   253.94744   138.85069       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_tx~s |      2,207         580           0        580        580

            |  Summary of total_gp_interactions
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         317           0       1,353
  CKD stage |          84           0         392
  CKD stage |           1           0          18
   Dialysis |          32           0          92
  Transplan |          58           0         307
  KRT uncle |           3           0          45
------------+------------------------------------
      Total |   218.72768   124.63563       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_gp~s |      2,207         495           0        495        495

            |     Summary of total_icd1_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         383           0       1,353
  CKD stage |         105           0         392
  CKD stage |          12           0          18
   Dialysis |          15           0          92
  Transplan |          90           0         307
  KRT uncle |           8           0          45
------------+------------------------------------
      Total |   266.85319   147.72839       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_ic~s |      2,207         613           0        613        613

            |     Summary of total_icd2_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         314           0       1,353
  CKD stage |          80           0         392
  CKD stage |           0           0          18
   Dialysis |          23           0          92
  Transplan |          97           0         307
  KRT uncle |           6           0          45
------------+------------------------------------
      Total |   221.28092   118.12554       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~2_days |      2,207         520           0        520        520

            |     Summary of total_icd3_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         336           0       1,353
  CKD stage |         109           0         392
  CKD stage |           7           0          18
   Dialysis |          24           0          92
  Transplan |          57           0         307
  KRT uncle |           4           0          45
------------+------------------------------------
      Total |   234.41278   129.83088       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~3_days |      2,207         537           0        537        537

            |     Summary of total_icd4_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         387           0       1,353
  CKD stage |         114           0         392
  CKD stage |           9           0          18
   Dialysis |          12           0          92
  Transplan |         101           0         307
  KRT uncle |           4           0          45
------------+------------------------------------
      Total |   272.20299   146.51053       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~4_days |      2,207         627           0        627        627

            |     Summary of total_icd5_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         403           0       1,353
  CKD stage |          88           0         392
  CKD stage |           5           0          18
   Dialysis |          24           0          92
  Transplan |          95           0         307
  KRT uncle |           8           0          45
------------+------------------------------------
      Total |   277.10829   159.51065       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~5_days |      2,207         623           0        623        623

            |     Summary of total_icd6_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         318           0       1,353
  CKD stage |          87           0         392
  CKD stage |           6           0          18
   Dialysis |          22           0          92
  Transplan |          71           0         307
  KRT uncle |           6           0          45
------------+------------------------------------
      Total |   221.36701   122.73662       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~6_days |      2,207         510           0        510        510

            |     Summary of total_icd7_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         325           0       1,353
  CKD stage |         110           0         392
  CKD stage |           0           0          18
   Dialysis |          58           0          92
  Transplan |          89           0         307
  KRT uncle |          13           0          45
------------+------------------------------------
      Total |   233.84187   116.06937       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~7_days |      2,207         595           0        595        595

            |     Summary of total_icd8_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         366           0       1,353
  CKD stage |          81           0         392
  CKD stage |           0           0          18
   Dialysis |          16           0          92
  Transplan |          98           0         307
  KRT uncle |           6           0          45
------------+------------------------------------
      Total |   253.18441   143.32235       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~8_days |      2,207         567           0        567        567

            |     Summary of total_icd9_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         379           0       1,353
  CKD stage |         123           0         392
  CKD stage |           0           0          18
   Dialysis |          44           0          92
  Transplan |          76           0         307
  KRT uncle |          21           0          45
------------+------------------------------------
      Total |   267.02673    142.6369       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~9_days |      2,207         643           0        643        643

            |     Summary of total_icd10_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         351           0       1,353
  CKD stage |          81           0         392
  CKD stage |           3           0          18
   Dialysis |          60           0          92
  Transplan |          85           0         307
  KRT uncle |           5           0          45
------------+------------------------------------
      Total |   244.01858   135.32384       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overa~0_days |      2,207         585           0        585        585

            |     Summary of total_icd11_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         325           0       1,353
  CKD stage |          84           0         392
  CKD stage |           2           0          18
   Dialysis |          28           0          92
  Transplan |          78           0         307
  KRT uncle |           2           0          45
------------+------------------------------------
      Total |   226.23516   125.34142       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~11_days |      2,207         519           0        519        519

            |     Summary of total_icd12_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         361           0       1,353
  CKD stage |         130           0         392
  CKD stage |           5           0          18
   Dialysis |          45           0          92
  Transplan |          63           0         307
  KRT uncle |           5           0          45
------------+------------------------------------
      Total |   255.18305   135.72809       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~12_days |      2,207         609           0        609        609

            |     Summary of total_icd13_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         352           0       1,353
  CKD stage |         109           0         392
  CKD stage |           5           0          18
   Dialysis |          24           0          92
  Transplan |          78           0         307
  KRT uncle |           4           0          45
------------+------------------------------------
      Total |   247.12642   133.70495       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~13_days |      2,207         572           0        572        572

            |     Summary of total_icd14_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         301           0       1,353
  CKD stage |          87           0         392
  CKD stage |           6           0          18
   Dialysis |          27           0          92
  Transplan |          84           0         307
  KRT uncle |          11           0          45
------------+------------------------------------
      Total |   213.06389   111.85426       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~14_days |      2,207         516           0        516        516

            |     Summary of total_icd15_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         281           0       1,353
  CKD stage |          66           0         392
  CKD stage |           7           0          18
   Dialysis |          24           0          92
  Transplan |          91           0         307
  KRT uncle |           2           0          45
------------+------------------------------------
      Total |   197.74626    106.1066       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~15_days |      2,207         471           0        471        471

            |     Summary of total_icd16_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         339           0       1,353
  CKD stage |          75           0         392
  CKD stage |           7           0          18
   Dialysis |          27           0          92
  Transplan |          74           0         307
  KRT uncle |          15           0          45
------------+------------------------------------
      Total |   232.92705   134.17001       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~16_days |      2,207         537           0        537        537

            |     Summary of total_icd17_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         392           0       1,353
  CKD stage |          92           0         392
  CKD stage |           1           0          18
   Dialysis |           5           0          92
  Transplan |         112           0         307
  KRT uncle |           0           0          45
------------+------------------------------------
      Total |    272.4522   152.42458       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~17_days |      2,207         602           0        602        602

            |     Summary of total_icd18_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         270           0       1,353
  CKD stage |          52           0         392
  CKD stage |          11           0          18
   Dialysis |          29           0          92
  Transplan |          49           0         307
  KRT uncle |          14           0          45
------------+------------------------------------
      Total |   183.15949   109.56113       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~18_days |      2,207         425           0        425        425

            |     Summary of total_icd19_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         311           0       1,353
  CKD stage |         102           0         392
  CKD stage |           7           0          18
   Dialysis |          23           0          92
  Transplan |          75           0         307
  KRT uncle |           6           0          45
------------+------------------------------------
      Total |   220.34617   115.76679       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~19_days |      2,207         524           0        524        524

            |     Summary of total_icd20_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         345           0       1,353
  CKD stage |         100           0         392
  CKD stage |           2           0          18
   Dialysis |          33           0          92
  Transplan |          91           0         307
  KRT uncle |          10           0          45
------------+------------------------------------
      Total |    243.5179   129.03614       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~20_days |      2,207         581           0        581        581

            |     Summary of total_icd21_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         323           0       1,353
  CKD stage |          84           0         392
  CKD stage |           6           0          18
   Dialysis |          41           0          92
  Transplan |          88           0         307
  KRT uncle |          21           0          45
------------+------------------------------------
      Total |   227.36203   121.16858       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~21_days |      2,207         563           0        563        563

            |     Summary of total_icd22_days
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |         360           0       1,353
  CKD stage |         113           0         392
  CKD stage |           3           0          18
   Dialysis |          24           0          92
  Transplan |          45           0         307
  KRT uncle |           5           0          45
------------+------------------------------------
      Total |   248.15496   143.01695       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
over~22_days |      2,207         550           0        550        550

. 
. 
. 
. **Potential effect modifiers
. * Ethnicity
. * 1 = White ethnicities (white British, white Irish, with other)
. * 2 = Mixed ethnicities (white & black Caribbean, white & black African, whit
> e & Asian, other mixed ethnicities)
. * 3 = South Asian ethnicities (Indian, Pakistani, Bangladeshi, other South As
> ian)
. * 4 = Black ethnicities (black Caribbean, black African, other black)
. * 5 = Other ethnicities (Chinese, all other ethnicities)
. * . = Unknown ethnicity
. replace ethnicity = . if ethnicity==.
(0 real changes made)

. replace ethnicity=6 if ethnicity==2
(55 real changes made)

. replace ethnicity=2 if ethnicity==3
(93 real changes made)

. replace ethnicity=3 if ethnicity==4
(90 real changes made)

. replace ethnicity=4 if ethnicity==6
(55 real changes made)

. replace ethnicity=6 if ethnicity==.
(573 real changes made)

. label define ethnicity  1 "White"                                       ///
>                                                 2 "South Asian"              
>            ///                                             
>                                                 3 "Black"                    
>                    ///
>                                                 4 "Mixed"                    
>                    ///
>                                                 5 "Other"                    
>                    ///
>                                                 6 "Unknown"     

. label values ethnicity ethnicity

. 
. * Index of multiple deprivation
. * Ordered 1-5 from most deprived to least deprived
. label define imd 1 "1 Most deprived" 2 "2" 3 "3" 4 "4" 5 "5 Least deprived"

. label values imd imd

. 
. * Region
. rename region region_string

. gen region = 1 if region_string=="East Midlands"
(1,979 missing values generated)

. replace region = 2 if region_string=="East"
(235 real changes made)

. replace region = 3 if region_string=="London"
(442 real changes made)

. replace region = 4 if region_string=="North East"
(194 real changes made)

. replace region = 5 if region_string=="North West"
(222 real changes made)

. replace region = 6 if region_string=="South East"
(229 real changes made)

. replace region = 7 if region_string=="South West"
(194 real changes made)

. replace region = 8 if region_string=="West Midlands"
(245 real changes made)

. replace region = 9 if region_string=="Yorkshire and The Humber"
(218 real changes made)

. label define region     1 "East Midlands"                                    
>    ///
>                                                 2 "East"                     
>                                    ///
>                                                 3 "London"                   
>                                    ///
>                                                 4 "North East"               
>                            ///
>                                                 5 "North West"               
>                            ///
>                                                 6 "South East"               
>                            ///
>                                                 7 "South West"               
>                            ///
>                                                 8 "West Midlands"            
>                            ///
>                                                 9 "Yorkshire and The Humber" 
>            

. label values region region

. label var region "Region"

. 
. * Urban/rural
. replace rural_urban=. if rural_urban<1|rural_urban>8
(0 real changes made)

. label define rural_urban 1 "Urban major conurbation"                         
>                    ///
>                                                  2 "Urban minor conurbation" 
>                                            ///
>                                                  3 "Urban city and town"     
>                                                    ///
>                                                  4 "Urban city and town in a 
> sparse setting"            ///
>                                                  5 "Rural town and fringe"   
>                                                    ///
>                                                  6 "Rural town and fringe in 
> a sparse setting"          ///
>                                                  7 "Rural village and dispers
> ed"                                        ///
>                                                  8 "Rural village and dispers
> ed in a sparse setting"

. label values rural_urban rural_urban

. * Urban (binary)
. * Urban = 1-4 + missing, Rural = 5-8
. generate urban=.
(2,207 missing values generated)

. replace urban=1 if rural_urban<=4|rural_urban==.
(855 real changes made)

. replace urban=0 if rural_urban>4 & rural_urban!=.
(1,352 real changes made)

. label var urban "Urban/rural"

. label define urban 0 "Rural" 1 "Urban"

. label values urban urban

. drop rural_urban

. 
. *Age bands for standardisation
. egen agecat = cut(age), at(0,18,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,
> 200)

. drop if agecat==0
(0 observations deleted)

. 
. *Age-standardisation weights (European Standard Population 2013)
. gen weight = .
(2,207 missing values generated)

. replace weight = 0.027261 if agecat==18
(53 real changes made)

. replace weight = 0.074349 if agecat==20
(164 real changes made)

. replace weight = 0.074349 if agecat==25
(179 real changes made)

. replace weight = 0.080545 if agecat==30
(187 real changes made)

. replace weight = 0.086741 if agecat==35
(195 real changes made)

. replace weight = 0.086741 if agecat==40
(147 real changes made)

. replace weight = 0.086741 if agecat==45
(200 real changes made)

. replace weight = 0.086741 if agecat==50
(178 real changes made)

. replace weight = 0.080545 if agecat==55
(174 real changes made)

. replace weight = 0.074349 if agecat==60
(172 real changes made)

. replace weight = 0.068154 if agecat==65
(147 real changes made)

. replace weight = 0.061958 if agecat==70
(149 real changes made)

. replace weight = 0.049566 if agecat==75
(104 real changes made)

. replace weight = 0.030979 if agecat==80
(80 real changes made)

. replace weight = 0.018587 if agecat==85
(47 real changes made)

. replace weight = 0.012392 if agecat==90
(31 real changes made)

. 
. 
. *Age standardised counts for each non-binary healthcare resource outcomes
. foreach aggregate of varlist hospital_days critical_care_days emergency_days 
> op_appts neph_appts tx_appts gp_interactions icd1_days icd2_days icd3_days ic
> d4_days icd5_days icd6_days icd7_days icd8_days icd9_days icd10_days icd11_da
> ys icd12_days icd13_days icd14_days icd15_days icd16_days icd17_days icd18_da
> ys icd19_days icd20_days icd21_days icd22_days {
  2. replace `aggregate' = `aggregate' * weight
  3. }
variable hospital_days was byte now float
(179 real changes made)
variable critical_care_days was byte now float
(190 real changes made)
variable emergency_days was byte now float
(196 real changes made)
variable op_appts was byte now float
(187 real changes made)
variable neph_appts was byte now float
(191 real changes made)
variable tx_appts was byte now float
(192 real changes made)
variable gp_interactions was byte now float
(173 real changes made)
variable icd1_days was byte now float
(195 real changes made)
variable icd2_days was byte now float
(181 real changes made)
variable icd3_days was byte now float
(167 real changes made)
variable icd4_days was byte now float
(200 real changes made)
variable icd5_days was byte now float
(213 real changes made)
variable icd6_days was byte now float
(176 real changes made)
variable icd7_days was byte now float
(199 real changes made)
variable icd8_days was byte now float
(190 real changes made)
variable icd9_days was byte now float
(218 real changes made)
variable icd10_days was byte now float
(197 real changes made)
variable icd11_days was byte now float
(182 real changes made)
variable icd12_days was byte now float
(194 real changes made)
variable icd13_days was byte now float
(190 real changes made)
variable icd14_days was byte now float
(190 real changes made)
variable icd15_days was byte now float
(174 real changes made)
variable icd16_days was byte now float
(188 real changes made)
variable icd17_days was byte now float
(198 real changes made)
variable icd18_days was byte now float
(156 real changes made)
variable icd19_days was byte now float
(183 real changes made)
variable icd20_days was byte now float
(195 real changes made)
variable icd21_days was byte now float
(179 real changes made)
variable icd22_days was byte now float
(189 real changes made)

. 
. * Create variable for age-standardised total # of each aggregated outcome
. * `var'_`aggregate' = age-standardised total # of each aggregated outcome ove
> rall stratified by ethnicity/imd/region/urban
. * `var'_`aggregate'_ckd = age-standardised total # of each aggregated outcome
>  in each CKD group stratified by ethnicity/imd/region/urban
. foreach aggregate of varlist hospital_days critical_care_days emergency_days 
> op_appts neph_appts tx_appts gp_interactions icd1_days icd2_days icd3_days ic
> d4_days icd5_days icd6_days icd7_days icd8_days icd9_days icd10_days icd11_da
> ys icd12_days icd13_days icd14_days icd15_days icd16_days icd17_days icd18_da
> ys icd19_days icd20_days icd21_days icd22_days {
  2. egen overall_std_`aggregate' = total(`aggregate')
  3. bysort ckd_group: egen std_`aggregate' = total(`aggregate')
  4. foreach var of varlist ethnicity imd region urban {
  5. bysort `var': egen `var'_`aggregate' = total(`aggregate')
  6. bysort `var' ckd_group: egen `var'_`aggregate'_ckd = total(`aggregate')
  7. }
  8. }

. 
. foreach binary of varlist fistula_formation pd_insertion blood_pressure album
> inuria creatinine icd1 icd2 icd3 icd4 icd5 icd6 icd7 icd8 icd9 icd10 icd11 ic
> d12 icd13 icd14 icd15 icd16 icd17 icd18 icd19 icd20 icd21 icd22 {
  2. gen esp_`binary' = `binary' * weight
  3. egen overall_std_`binary' = total(esp_`binary')
  4. bysort ckd_group: egen std_`binary' = total(esp_`binary')
  5. foreach var of varlist ethnicity imd region urban {
  6. bysort `var': egen `var'_`binary' = total(esp_`binary')
  7. bysort `var' ckd_group: egen `var'_`binary'_ckd = total(esp_`binary')
  8. }
  9. }

. 
. *Merge cost data
. save "./output/`dataset'_ckd_complete.dta", replace
(note: file ./output/2022_ckd_complete.dta not found)
file ./output/2022_ckd_complete.dta saved

. capture noisily import delimited ./output/costs_`dataset'.csv, clear
(7 vars, 500 obs)

. keep patient_id apcs_cost ec_cost opa_cost

. merge 1:1 patient_id using ./output/`dataset'_ckd_complete
(note: variable patient_id was int, now long to accommodate using data's
       values)

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,703
        from master                       498  (_merge==1)
        from using                      2,205  (_merge==2)

    matched                                 2  (_merge==3)
    -----------------------------------------

. drop if _merge==1
(498 observations deleted)

. foreach cost of varlist apcs_cost ec_cost opa_cost {
  2. sum `cost', d
  3. bysort ckd_group: egen total_`cost' = total(`cost')
  4. egen overall_`cost' = total(`cost')
  5. tab ckd_group, sum(total_`cost')
  6. sum overall_`cost'
  7. foreach var of varlist ethnicity imd region urban {
  8. bysort `var': egen `var'_`cost' = total(`cost')
  9. bysort `var' ckd_group: egen `var'_`cost'_ckd = total(`cost')
 10. }
 11. }

                          apcs_cost
-------------------------------------------------------------
      Percentiles      Smallest
 1%     146.8858       146.8858
 5%     146.8858              .
10%     146.8858              .       Obs                   1
25%     146.8858              .       Sum of Wgt.           1

50%     146.8858                      Mean           146.8858
                        Largest       Std. Dev.             .
75%     146.8858              .
90%     146.8858              .       Variance              .
95%     146.8858              .       Skewness              .
99%     146.8858       146.8858       Kurtosis              .

            |     Summary of total_apcs_cost
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |   146.88582           0       1,353
  CKD stage |           0           0         392
  CKD stage |           0           0          18
   Dialysis |           0           0          92
  Transplan |           0           0         307
  KRT uncle |           0           0          45
------------+------------------------------------
      Total |   90.048261   71.557273       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_ap~t |      2,207    146.8858           0   146.8858   146.8858

                           ec_cost
-------------------------------------------------------------
      Percentiles      Smallest
 1%     34.58662       34.58662
 5%     34.58662              .
10%     34.58662              .       Obs                   1
25%     34.58662              .       Sum of Wgt.           1

50%     34.58662                      Mean           34.58662
                        Largest       Std. Dev.             .
75%     34.58662              .
90%     34.58662              .       Variance              .
95%     34.58662              .       Skewness              .
99%     34.58662       34.58662       Kurtosis              .

            |      Summary of total_ec_cost
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |   34.586617           0       1,353
  CKD stage |           0           0         392
  CKD stage |           0           0          18
   Dialysis |           0           0          92
  Transplan |           0           0         307
  KRT uncle |           0           0          45
------------+------------------------------------
      Total |   21.203304   16.849305       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_ec~t |      2,207    34.58662           0   34.58662   34.58662

                          opa_cost
-------------------------------------------------------------
      Percentiles      Smallest
 1%     162.9006       162.9006
 5%     162.9006              .
10%     162.9006              .       Obs                   1
25%     162.9006              .       Sum of Wgt.           1

50%     162.9006                      Mean           162.9006
                        Largest       Std. Dev.             .
75%     162.9006              .
90%     162.9006              .       Variance              .
95%     162.9006              .       Skewness              .
99%     162.9006       162.9006       Kurtosis              .

            |      Summary of total_opa_cost
  CKD group |        Mean   Std. Dev.       Freq.
------------+------------------------------------
  Albuminur |   162.90056           0       1,353
  CKD stage |           0           0         392
  CKD stage |           0           0          18
   Dialysis |           0           0          92
  Transplan |           0           0         307
  KRT uncle |           0           0          45
------------+------------------------------------
      Total |   99.866088   79.359055       2,207

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
overall_op~t |      2,207    162.9006           0   162.9006   162.9006

. save "./output/`dataset'_ckd_complete.dta", replace
file ./output/2022_ckd_complete.dta saved

. 
. log close
      name:  <unnamed>
       log:  /workspace/logs/2022_ckd_complete.log
  log type:  text
 closed on:   7 Jun 2024, 10:22:32
-------------------------------------------------------------------------------
